@namespace BlazzyMotion.Gallery.Components
@using BlazzyMotion.Core.Models
@using BlazzyMotion.Gallery.Models
@typeparam TItem where TItem : class
@inherits BlazzyMotion.Core.Abstractions.BzComponentBase

@if (IsLoading)
{
    <div class="bz-loading" @attributes="AdditionalAttributes">
        @if (LoadingTemplate != null)
        {
            @LoadingTemplate
        }
        else
        {
            <div class="bz-spinner"></div>
            <p>Loading gallery...</p>
        }
    </div>
}
else if (IsEmpty)
{
    <div class="bz-empty" @attributes="AdditionalAttributes">
        @if (EmptyTemplate != null)
        {
            @EmptyTemplate
        }
        else
        {
            <p>No items to display</p>
        }
    </div>
}
else
{
    <div class="@GetContainerClass()"
         style="@GetContainerStyle()"
         @ref="_galleryRef"
         @attributes="AdditionalAttributes">

        @if (EnableFilter && _categories.Count > 1)
        {
            <div class="bzg-filter-bar" role="toolbar" aria-label="Filter by category">
                <button class="bzg-filter-btn @(_activeCategory == null ? "bzg-filter-active" : "")"
                        aria-pressed="@(_activeCategory == null ? "true" : "false")"
                        @onclick="() => SetFilter(null)">
                    All
                </button>
                @foreach (var category in _categories)
                {
                    var cat = category;
                    <button class="bzg-filter-btn @(_activeCategory == cat ? "bzg-filter-active" : "")"
                            aria-pressed="@(_activeCategory == cat ? "true" : "false")"
                            @onclick="() => SetFilter(cat)">
                        @cat
                    </button>
                }
            </div>
        }

        <div class="@GetGridClass()"
             style="@GetGridStyle()">

            @if (MappedItems != null)
            {
                @for (var i = 0; i < MappedItems.Count; i++)
                {
                    var index = i;
                    var item = MappedItems[i];
                    <div class="@GetItemClass(item)"
                         data-category="@GetItemCategory(item)"
                         tabindex="0"
                         role="button"
                         aria-label="@GetItemAriaLabel(item, index)"
                         @onclick="() => OnItemClick(index)"
                         @onkeydown="@(e => OnItemKeyDown(e, index))">

                        @if (ItemTemplate != null)
                        {
                            @ItemTemplate(item.GetOriginal<TItem>()!)
                        }
                        else
                        {
                            @if (item.HasImage)
                            {
                                <div class="bzg-image-wrapper">
                                    <img class="bzg-image"
                                         src="@item.ImageUrl"
                                         alt="@(item.HasTitle ? item.Title : "Gallery image")"
                                         loading="lazy"
                                         draggable="false" />

                                    <div class="bzg-overlay" aria-hidden="true">
                                        @if (EnableLightbox)
                                        {
                                            <div class="bzg-overlay-icon">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="11" cy="11" r="8"></circle>
                                                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                                    <line x1="11" y1="8" x2="11" y2="14"></line>
                                                    <line x1="8" y1="11" x2="14" y2="11"></line>
                                                </svg>
                                            </div>
                                        }

                                        @if (item.HasTitle)
                                        {
                                            <h4 class="bzg-overlay-title">@item.Title</h4>
                                        }

                                        @if (!string.IsNullOrWhiteSpace(item.Description) && Layout == BzGalleryLayout.List)
                                        {
                                            <p class="bzg-overlay-desc">@item.Description</p>
                                        }
                                    </div>
                                </div>
                            }

                            @if (Layout == BzGalleryLayout.List && (item.HasTitle || !string.IsNullOrWhiteSpace(item.Description)))
                            {
                                <div class="bzg-list-info">
                                    @if (item.HasTitle)
                                    {
                                        <h4 class="bzg-list-title">@item.Title</h4>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(item.Description))
                                    {
                                        <p class="bzg-list-desc">@item.Description</p>
                                    }
                                </div>
                            }
                        }
                    </div>
                }
            }
        </div>

        @if (HasNoFilterResults)
        {
            <p class="bzg-no-results" role="status" aria-live="polite">No items match this filter</p>
        }
    </div>

    @if (EnableLightbox)
    {
        <BzGalleryLightbox Items="FilteredItems"
                           CurrentIndex="_lightboxIndex"
                           IsOpen="_lightboxOpen"
                           OnClose="CloseLightbox"
                           OnIndexChanged="OnLightboxIndexChanged" />
    }
}
