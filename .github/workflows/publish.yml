name: ðŸ“¦ Publish NuGet

on:
  workflow_dispatch:
    inputs:
      core_version:
        description: "Core Package Version (e.g., 1.0.0)"
        required: true
        default: "1.0.0"
        type: string
      carousel_version:
        description: "Carousel Package Version (e.g., 1.1.0)"
        required: true
        default: "1.1.0"
        type: string
      bento_version:
        description: "Bento Package Version (e.g., 1.0.0)"
        required: true
        default: "1.0.0"
        type: string
      gallery_version:
        description: "Gallery Package Version (e.g., 1.0.0)"
        required: true
        default: "1.0.0"
        type: string
      publish_core:
        description: "Publish Core package?"
        required: true
        default: true
        type: boolean
      publish_carousel:
        description: "Publish Carousel package?"
        required: true
        default: true
        type: boolean
      publish_bento:
        description: "Publish Bento package?"
        required: true
        default: true
        type: boolean
      publish_gallery:
        description: "Publish Gallery package?"
        required: true
        default: true
        type: boolean

env:
  DOTNET_VERSION: "8.0.x"
  CORE_PROJECT: "src/BlazzyMotion.Core/BlazzyMotion.Core.csproj"
  CAROUSEL_PROJECT: "src/BlazzyMotion.Carousel/BlazzyMotion.Carousel.csproj"
  BENTO_PROJECT: "src/BlazzyMotion.Bento/BlazzyMotion.Bento.csproj"
  GALLERY_PROJECT: "src/BlazzyMotion.Gallery/BlazzyMotion.Gallery.csproj"

jobs:
  publish:
    name: Pack & Publish
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      CORE_VERSION: ${{ inputs.core_version }}
      CAROUSEL_VERSION: ${{ inputs.carousel_version }}
      BENTO_VERSION: ${{ inputs.bento_version }}
      GALLERY_VERSION: ${{ inputs.gallery_version }}
      PUBLISH_CORE: ${{ inputs.publish_core }}
      PUBLISH_CAROUSEL: ${{ inputs.publish_carousel }}
      PUBLISH_BENTO: ${{ inputs.publish_bento }}
      PUBLISH_GALLERY: ${{ inputs.publish_gallery }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore Dependencies
        run: dotnet restore

      - name: Build Solution (Release)
        run: |
          dotnet build --configuration Release --no-restore \
            /p:BlazzyCoreVersion="$CORE_VERSION" \
            /p:BlazzyCarouselVersion="$CAROUSEL_VERSION" \
            /p:BlazzyBentoVersion="$BENTO_VERSION" \
            /p:BlazzyGalleryVersion="$GALLERY_VERSION"

      - name: Run Tests
        run: dotnet test --configuration Release --no-build --verbosity normal

      - name: Pack BlazzyMotion.Core
        if: ${{ inputs.publish_core }}
        run: |
          dotnet pack ${{ env.CORE_PROJECT }} \
            --configuration Release \
            --no-build \
            --output ./nupkgs \
            /p:BlazzyCoreVersion="$CORE_VERSION"

      - name: Pack BlazzyMotion.Carousel
        if: ${{ inputs.publish_carousel }}
        run: |
          dotnet pack ${{ env.CAROUSEL_PROJECT }} \
            --configuration Release \
            --no-build \
            --output ./nupkgs \
            /p:BlazzyCarouselVersion="$CAROUSEL_VERSION" \
            /p:BlazzyCoreVersion="$CORE_VERSION"

      - name: Pack BlazzyMotion.Bento
        if: ${{ inputs.publish_bento }}
        run: |
          dotnet pack ${{ env.BENTO_PROJECT }} \
            --configuration Release \
            --no-build \
            --output ./nupkgs \
            /p:BlazzyBentoVersion="$BENTO_VERSION" \
            /p:BlazzyCoreVersion="$CORE_VERSION"

      - name: Pack BlazzyMotion.Gallery
        if: ${{ inputs.publish_gallery }}
        run: |
          dotnet pack ${{ env.GALLERY_PROJECT }} \
            --configuration Release \
            --no-build \
            --output ./nupkgs \
            /p:BlazzyGalleryVersion="$GALLERY_VERSION" \
            /p:BlazzyCoreVersion="$CORE_VERSION"

      - name: List Packages
        run: ls -lah ./nupkgs

      - name: Verify Carousel Package Dependencies
        if: ${{ inputs.publish_carousel }}
        run: |
          echo "=== Verifying Carousel package dependencies ==="
          unzip -p ./nupkgs/BlazzyMotion.Carousel.*.nupkg "*.nuspec" | grep -A5 "<dependencies>"
          echo ""
          echo "Expected Core dependency version: $CORE_VERSION"

      - name: Verify Bento Package Dependencies
        if: ${{ inputs.publish_bento }}
        run: |
          echo "=== Verifying Bento package dependencies ==="
          unzip -p ./nupkgs/BlazzyMotion.Bento.*.nupkg "*.nuspec" | grep -A5 "<dependencies>"
          echo ""
          echo "Expected Core dependency version: $CORE_VERSION"

      - name: Verify Gallery Package Dependencies
        if: ${{ inputs.publish_gallery }}
        run: |
          echo "=== Verifying Gallery package dependencies ==="
          unzip -p ./nupkgs/BlazzyMotion.Gallery.*.nupkg "*.nuspec" | grep -A5 "<dependencies>"
          echo ""
          echo "Expected Core dependency version: $CORE_VERSION"

      - name: Push to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          for package in ./nupkgs/*.nupkg; do
            echo "Publishing: $package"
            dotnet nuget push "$package" \
              --api-key "$NUGET_API_KEY" \
              --source https://api.nuget.org/v3/index.json \
              --skip-duplicate
          done

      - name: Create Git Tags
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ "$PUBLISH_CORE" = "true" ]; then
            git tag -a "core-v$CORE_VERSION" -m "Release BlazzyMotion.Core v$CORE_VERSION" || true
            git push origin "core-v$CORE_VERSION" || echo "Tag already exists"
          fi

          if [ "$PUBLISH_CAROUSEL" = "true" ]; then
            git tag -a "carousel-v$CAROUSEL_VERSION" -m "Release BlazzyMotion.Carousel v$CAROUSEL_VERSION" || true
            git push origin "carousel-v$CAROUSEL_VERSION" || echo "Tag already exists"
          fi

          if [ "$PUBLISH_BENTO" = "true" ]; then
            git tag -a "bento-v$BENTO_VERSION" -m "Release BlazzyMotion.Bento v$BENTO_VERSION" || true
            git push origin "bento-v$BENTO_VERSION" || echo "Tag already exists"
          fi

          if [ "$PUBLISH_GALLERY" = "true" ]; then
            git tag -a "gallery-v$GALLERY_VERSION" -m "Release BlazzyMotion.Gallery v$GALLERY_VERSION" || true
            git push origin "gallery-v$GALLERY_VERSION" || echo "Tag already exists"
          fi

      - name: Publication Summary
        run: |
          echo "### ðŸŽ‰ NuGet Packages Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PUBLISH_CORE" = "true" ]; then
            echo "#### BlazzyMotion.Core" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** $CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **NuGet:** https://www.nuget.org/packages/BlazzyMotion.Core/$CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`core-v$CORE_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PUBLISH_CAROUSEL" = "true" ]; then
            echo "#### BlazzyMotion.Carousel" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** $CAROUSEL_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Depends on:** BlazzyMotion.Core >= $CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **NuGet:** https://www.nuget.org/packages/BlazzyMotion.Carousel/$CAROUSEL_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`carousel-v$CAROUSEL_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PUBLISH_BENTO" = "true" ]; then
            echo "#### BlazzyMotion.Bento" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** $BENTO_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Depends on:** BlazzyMotion.Core >= $CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **NuGet:** https://www.nuget.org/packages/BlazzyMotion.Bento/$BENTO_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`bento-v$BENTO_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$PUBLISH_GALLERY" = "true" ]; then
            echo "#### BlazzyMotion.Gallery" >> $GITHUB_STEP_SUMMARY
            echo "- **Version:** $GALLERY_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Depends on:** BlazzyMotion.Core >= $CORE_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **NuGet:** https://www.nuget.org/packages/BlazzyMotion.Gallery/$GALLERY_VERSION" >> $GITHUB_STEP_SUMMARY
            echo "- **Tag:** \`gallery-v$GALLERY_VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          if [ "$PUBLISH_CAROUSEL" = "true" ]; then
            echo "# Install Carousel (automatically installs Core)" >> $GITHUB_STEP_SUMMARY
            echo "dotnet add package BlazzyMotion.Carousel --version $CAROUSEL_VERSION" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$PUBLISH_BENTO" = "true" ]; then
            echo "# Install Bento (automatically installs Core)" >> $GITHUB_STEP_SUMMARY
            echo "dotnet add package BlazzyMotion.Bento --version $BENTO_VERSION" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$PUBLISH_GALLERY" = "true" ]; then
            echo "# Install Gallery (automatically installs Core)" >> $GITHUB_STEP_SUMMARY
            echo "dotnet add package BlazzyMotion.Gallery --version $GALLERY_VERSION" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$PUBLISH_CORE" = "true" ] && [ "$PUBLISH_CAROUSEL" != "true" ] && [ "$PUBLISH_BENTO" != "true" ] && [ "$PUBLISH_GALLERY" != "true" ]; then
            echo "# Install Core only" >> $GITHUB_STEP_SUMMARY
            echo "dotnet add package BlazzyMotion.Core --version $CORE_VERSION" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
